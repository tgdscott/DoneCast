<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helter Shelter</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div id="root" class="min-h-screen"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel" data-presets="react">
    const { useState, useMemo, useCallback, useEffect } = React;

    const BOARD_SIZE = 8;
    const MAX_LOG_ENTRIES = 8;
    const POLICE_THRESHOLD = 100;
    const POLICE_TIMER_TURNS = 5;

    const DIRECTIONS = {
      up: { label: 'Up', dx: 0, dy: -1 },
      down: { label: 'Down', dx: 0, dy: 1 },
      left: { label: 'Left', dx: -1, dy: 0 },
      right: { label: 'Right', dx: 1, dy: 0 }
    };

    const keyFor = (x, y) => `${x},${y}`;

    const inBounds = (x, y) => x >= 0 && y >= 0 && x < BOARD_SIZE && y < BOARD_SIZE;

    const manhattan = (a, b) => Math.abs(a.x - b.x) + Math.abs(a.y - b.y);

    const shuffle = (arr) => {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    };

    const createInitialState = () => ({
      player: { x: 1, y: 6 },
      animals: [
        { id: 'a1', x: 2, y: 5, scheduled: false },
        { id: 'a2', x: 4, y: 2, scheduled: true },
        { id: 'a3', x: 5, y: 6, scheduled: false },
        { id: 'a4', x: 1, y: 2, scheduled: true },
        { id: 'a5', x: 6, y: 4, scheduled: false }
      ],
      volunteers: [
        { id: 'v1', x: 3, y: 6 },
        { id: 'v2', x: 5, y: 3 }
      ],
      families: [
        { id: 'f1', x: 2, y: 7 },
        { id: 'f2', x: 6, y: 1 }
      ],
      workers: [
        { id: 'w1', x: 6, y: 5, trapped: false },
        { id: 'w2', x: 0, y: 2, trapped: false }
      ],
      pens: [
        { id: 'p1', x: 0, y: 7 },
        { id: 'p2', x: 7, y: 0 },
        { id: 'p3', x: 7, y: 7 }
      ],
      turn: 0,
      score: 0,
      suspicion: 10,
      freedCount: 0,
      trappedCount: 0,
      adoptedCount: 0,
      policeCalled: false,
      policeTimer: POLICE_TIMER_TURNS,
      log: [
        'You slip into the shelter after hours. Keep it quiet and free who you can!',
        'Workers will radio for help if they spot you. Stay out of their sight.',
        'Convince visiting families with help from volunteers to adopt waiting pets.'
      ],
      status: null
    });

    const findAvailablePen = (pens, occupiedKeys) => pens.find((pen) => !occupiedKeys.has(keyFor(pen.x, pen.y)));

    const spawnWorker = (entities, pens) => {
      const occupied = new Set(entities.map((entity) => keyFor(entity.x, entity.y)));
      pens.forEach((pen) => occupied.add(keyFor(pen.x, pen.y)));

      const edgePositions = [];
      for (let i = 0; i < BOARD_SIZE; i += 1) {
        edgePositions.push({ x: i, y: 0 });
        edgePositions.push({ x: i, y: BOARD_SIZE - 1 });
        edgePositions.push({ x: 0, y: i });
        edgePositions.push({ x: BOARD_SIZE - 1, y: i });
      }

      const shuffled = shuffle(edgePositions);
      for (const pos of shuffled) {
        if (!occupied.has(keyFor(pos.x, pos.y))) {
          return { id: `w${Math.random().toString(36).slice(2, 7)}`, x: pos.x, y: pos.y, trapped: false };
        }
      }
      return null;
    };

    const moveWorkers = (workers, player, occupiedTargets) => {
      const nextWorkers = [];
      const taken = new Set(occupiedTargets);

      workers.forEach((worker) => {
        if (worker.trapped) {
          nextWorkers.push(worker);
          taken.add(keyFor(worker.x, worker.y));
          return;
        }

        const deltas = shuffle([
          { dx: 1, dy: 0 },
          { dx: -1, dy: 0 },
          { dx: 0, dy: 1 },
          { dx: 0, dy: -1 },
          { dx: 0, dy: 0 }
        ]);

        let best = { ...worker };
        let bestDistance = manhattan(worker, player);

        deltas.forEach(({ dx, dy }) => {
          const nx = worker.x + dx;
          const ny = worker.y + dy;
          if (!inBounds(nx, ny)) return;
          const k = keyFor(nx, ny);
          if (taken.has(k)) return;
          const candidate = { ...worker, x: nx, y: ny };
          const distance = manhattan(candidate, player);
          if (distance <= bestDistance) {
            best = candidate;
            bestDistance = distance;
          }
        });

        taken.add(keyFor(best.x, best.y));
        nextWorkers.push(best);
      });

      return nextWorkers;
    };

    function HelterShelterGame() {
      const [state, setState] = useState(() => createInitialState());

      const addLog = useCallback((entry) => {
        setState((prev) => ({
          ...prev,
          log: [entry, ...prev.log].slice(0, MAX_LOG_ENTRIES)
        }));
      }, []);

      const resetGame = useCallback(() => {
        setState(createInitialState());
      }, []);

      const resolveTurn = useCallback((mutations) => {
        setState((prev) => {
          if (prev.status) return prev;

          const {
            player = prev.player,
            animals = prev.animals,
            volunteers = prev.volunteers,
            families = prev.families,
            workers = prev.workers,
            scoreDelta = 0,
            freedDelta = 0,
            trappedDelta = 0,
            adoptedDelta = 0,
            message
          } = mutations;

          let newScore = prev.score + scoreDelta;
          let newTurn = prev.turn + 1;
          let newFreed = prev.freedCount + freedDelta;
          let newTrapped = prev.trappedCount + trappedDelta;
          let newAdopted = prev.adoptedCount + adoptedDelta;
          let newLog = prev.log;
          if (message) {
            newLog = [message, ...prev.log].slice(0, MAX_LOG_ENTRIES);
          }

          const occupiedByAllies = new Set([
            ...animals.map((a) => keyFor(a.x, a.y)),
            ...volunteers.map((v) => keyFor(v.x, v.y)),
            ...families.map((f) => keyFor(f.x, f.y)),
            keyFor(player.x, player.y)
          ]);
          const movedWorkers = moveWorkers(workers, player, occupiedByAllies);

          let suspicionGain = 2;
          let caught = false;
          movedWorkers.forEach((worker) => {
            if (worker.trapped) return;
            const dist = manhattan(worker, player);
            if (dist === 0) {
              suspicionGain = POLICE_THRESHOLD;
              caught = true;
            } else if (dist === 1) {
              suspicionGain += 35;
            } else if (dist === 2) {
              suspicionGain += 18;
            }
          });

          let newSuspicion = Math.min(POLICE_THRESHOLD + 20, prev.suspicion + suspicionGain);
          let policeCalled = prev.policeCalled;
          let policeTimer = prev.policeTimer;
          let status = prev.status;
          let postLog = newLog;

          if (!policeCalled && newSuspicion >= POLICE_THRESHOLD) {
            policeCalled = true;
            policeTimer = POLICE_TIMER_TURNS;
            postLog = ['The workers radio the police! Wrap up fast.', ...newLog].slice(0, MAX_LOG_ENTRIES);
          }

          if (policeCalled) {
            const nextTimer = Math.max(0, policeTimer - 1);
            policeTimer = nextTimer;
            if (nextTimer === 0 || caught) {
              newScore -= 25;
              status = { type: 'caught', message: 'The police arrive and you are arrested. -25 points.' };
              postLog = ['You were caught and hauled off to jail.', ...postLog].slice(0, MAX_LOG_ENTRIES);
            }
          }

          let extraLog = postLog;
          if (newTurn % 4 === 0 && !status) {
            const spawn = spawnWorker(
              [
                { ...player },
                ...animals,
                ...volunteers,
                ...families,
                ...movedWorkers
              ],
              prev.pens
            );
            if (spawn) {
              movedWorkers.push(spawn);
              extraLog = [`Reinforcement worker ${spawn.id.toUpperCase()} enters the shelter.`, ...postLog].slice(0, MAX_LOG_ENTRIES);
            }
          }

          return {
            ...prev,
            player,
            animals,
            volunteers,
            families,
            workers: movedWorkers,
            score: newScore,
            freedCount: newFreed,
            trappedCount: newTrapped,
            adoptedCount: newAdopted,
            suspicion: newSuspicion,
            policeCalled,
            policeTimer,
            status,
            turn: newTurn,
            log: extraLog
          };
        });
      }, []);

      const handleMove = useCallback((direction) => {
        if (state.status) return;
        const dir = DIRECTIONS[direction];
        const nx = Math.min(BOARD_SIZE - 1, Math.max(0, state.player.x + dir.dx));
        const ny = Math.min(BOARD_SIZE - 1, Math.max(0, state.player.y + dir.dy));
        if (nx === state.player.x && ny === state.player.y) {
          addLog('You press against the wall and hold your breath.');
          return;
        }
        resolveTurn({ player: { x: nx, y: ny }, message: `You sneak ${direction}.` });
      }, [addLog, resolveTurn, state.player.x, state.player.y, state.status]);

      const handleFreeAnimal = useCallback(() => {
        if (state.status) return;
        const animal = state.animals.find((a) => a.x === state.player.x && a.y === state.player.y);
        if (!animal) {
          addLog('No animal is caged here. Try another kennel.');
          return;
        }
        const remaining = state.animals.filter((a) => a.id !== animal.id);
        resolveTurn({
          player: state.player,
          animals: remaining,
          scoreDelta: 1,
          freedDelta: 1,
          message: animal.scheduled
            ? 'You free a pet who was scheduled for euthanasia. They bolt for the door! (+1)'
            : 'You unlatch a kennel and set a pet free. (+1)'
        });
      }, [addLog, resolveTurn, state.animals, state.player, state.status]);

      const handleTrapWorker = useCallback(() => {
        if (state.status) return;
        const nearbyWorker = state.workers.find((worker) => !worker.trapped && manhattan(worker, state.player) === 1);
        if (!nearbyWorker) {
          addLog('No worker is close enough to shove into a pen.');
          return;
        }
        const occupiedPens = new Set(
          state.workers.filter((w) => w.trapped).map((w) => keyFor(w.x, w.y))
        );
        const pen = findAvailablePen(state.pens, occupiedPens);
        if (!pen) {
          addLog('Every pen already holds a trapped worker!');
          return;
        }
        const updatedWorkers = state.workers.map((worker) => {
          if (worker.id === nearbyWorker.id) {
            return { ...worker, x: pen.x, y: pen.y, trapped: true };
          }
          return worker;
        });
        resolveTurn({
          player: state.player,
          workers: updatedWorkers,
          scoreDelta: 5,
          trappedDelta: 1,
          message: 'You and a volunteer slam a worker into an empty pen. (+5)'
        });
      }, [addLog, resolveTurn, state.pens, state.player, state.workers, state.status]);

      const handleAdoption = useCallback(() => {
        if (state.status) return;
        const adjacentFamily = state.families.find((family) => manhattan(family, state.player) === 1);
        if (!adjacentFamily) {
          addLog('You need to be next to a visiting family to pitch an adoption.');
          return;
        }
        const helpfulVolunteer = state.volunteers.find((vol) => manhattan(vol, adjacentFamily) <= 1);
        if (!helpfulVolunteer) {
          addLog('Wave a volunteer over so the family trusts you. Find one nearby.');
          return;
        }
        if (state.animals.length === 0) {
          addLog('No adoptable animals remain in the kennels!');
          return;
        }
        const scheduled = state.animals.find((animal) => animal.scheduled);
        const chosenAnimal = scheduled || state.animals[0];
        const remainingAnimals = state.animals.filter((animal) => animal.id !== chosenAnimal.id);
        const remainingFamilies = state.families.filter((family) => family.id !== adjacentFamily.id);
        resolveTurn({
          player: state.player,
          animals: remainingAnimals,
          families: remainingFamilies,
          scoreDelta: 10,
          adoptedDelta: 1,
          message: 'A family signs the papers and heads home with a new friend! (+10)'
        });
      }, [addLog, resolveTurn, state.animals, state.families, state.player, state.status, state.volunteers]);

      const handleWait = useCallback(() => {
        if (state.status) return;
        resolveTurn({ player: state.player, message: 'You pause in the shadows to plan your next move.' });
      }, [resolveTurn, state.player, state.status]);

      const handleEscape = useCallback(() => {
        setState((prev) => {
          if (prev.status) return prev;
          return {
            ...prev,
            status: { type: 'escaped', message: 'You slip out before the police arrive. Mission complete!' },
            log: ['You disappear into the night with the animals you saved.', ...prev.log].slice(0, MAX_LOG_ENTRIES)
          };
        });
      }, []);

      useEffect(() => {
        const handler = (event) => {
          if (state.status) return;
          if (event.key === 'ArrowUp') {
            event.preventDefault();
            handleMove('up');
          } else if (event.key === 'ArrowDown') {
            event.preventDefault();
            handleMove('down');
          } else if (event.key === 'ArrowLeft') {
            event.preventDefault();
            handleMove('left');
          } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            handleMove('right');
          }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, [handleMove, state.status]);

      const board = useMemo(() => {
        const cells = Array.from({ length: BOARD_SIZE }, () => Array.from({ length: BOARD_SIZE }, () => ({
          classes: 'bg-slate-900/70 border border-slate-700 flex items-center justify-center rounded-md text-xl',
          symbol: '',
          title: 'Empty floor'
        })));

        state.pens.forEach((pen) => {
          cells[pen.y][pen.x] = {
            ...cells[pen.y][pen.x],
            classes: 'bg-amber-900/60 border-amber-500/70 flex items-center justify-center rounded-md text-xl',
            symbol: 'ü™§',
            title: 'Empty holding pen'
          };
        });

        state.animals.forEach((animal) => {
          cells[animal.y][animal.x] = {
            classes: animal.scheduled
              ? 'bg-rose-900/60 border border-rose-500 flex items-center justify-center rounded-md text-xl'
              : 'bg-emerald-900/60 border border-emerald-500 flex items-center justify-center rounded-md text-xl',
            symbol: animal.scheduled ? '‚è∞üêæ' : 'üêæ',
            title: animal.scheduled ? 'Animal scheduled for euthanasia' : 'Caged animal'
          };
        });

        state.volunteers.forEach((volunteer) => {
          cells[volunteer.y][volunteer.x] = {
            classes: 'bg-sky-900/60 border border-sky-500 flex items-center justify-center rounded-md text-xl',
            symbol: 'üôã',
            title: 'Helpful volunteer'
          };
        });

        state.families.forEach((family) => {
          cells[family.y][family.x] = {
            classes: 'bg-indigo-900/60 border border-indigo-500 flex items-center justify-center rounded-md text-xl',
            symbol: 'üë™',
            title: 'Visiting family considering adoption'
          };
        });

        state.workers.forEach((worker) => {
          cells[worker.y][worker.x] = {
            classes: worker.trapped
              ? 'bg-amber-950 border border-amber-600 flex items-center justify-center rounded-md text-xl'
              : 'bg-red-950 border border-red-600 flex items-center justify-center rounded-md text-xl',
            symbol: worker.trapped ? 'üö´üë∑' : 'üë∑',
            title: worker.trapped ? 'Trapped city worker' : 'City worker on patrol'
          };
        });

        cells[state.player.y][state.player.x] = {
          classes: 'bg-emerald-800 border border-emerald-500 flex items-center justify-center rounded-md text-xl font-semibold text-emerald-50',
          symbol: 'üïµÔ∏è',
          title: 'You'
        };

        return cells;
      }, [state.animals, state.families, state.pens, state.player.x, state.player.y, state.volunteers, state.workers]);

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 py-10">
          <div className="max-w-6xl mx-auto px-4">
            <div className="space-y-6">
              <header className="bg-slate-900/80 border border-slate-700 rounded-xl p-6 shadow-lg shadow-emerald-500/10">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div>
                    <h1 className="text-3xl font-bold text-emerald-300">Helter Shelter</h1>
                    <p className="text-sm text-slate-300 mt-1">
                      Sneak through the city shelter, free at-risk animals, and rally families to adopt before the police arrive.
                    </p>
                  </div>
                  <div className="flex gap-4">
                    <div className="text-right">
                      <div className="text-xs uppercase tracking-wide text-slate-400">Turn</div>
                      <div className="text-2xl font-semibold">{state.turn}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-xs uppercase tracking-wide text-slate-400">Score</div>
                      <div className="text-2xl font-semibold text-emerald-300">{state.score}</div>
                    </div>
                  </div>
                </div>
              </header>

              <div className="grid lg:grid-cols-[2fr_1fr] gap-6">
                <div className="space-y-6">
                  <div className="bg-slate-900/80 border border-slate-700 rounded-xl p-6">
                    <div className="grid grid-cols-8 gap-2">
                      {board.map((row, y) =>
                        row.map((cell, x) => (
                          <div
                            key={`${x}-${y}`}
                            className={`${cell.classes} aspect-square relative`}
                            title={cell.title}
                          >
                            <span className="select-none">{cell.symbol}</span>
                          </div>
                        ))
                      )}
                    </div>

                    <div className="mt-6">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-slate-300">Suspicion</span>
                        <span className="text-sm font-semibold text-rose-300">{state.suspicion}/{POLICE_THRESHOLD}</span>
                      </div>
                      <div className="h-3 bg-slate-800 rounded-full mt-2 overflow-hidden">
                        <div
                          className="h-full bg-gradient-to-r from-emerald-500 via-amber-400 to-rose-500"
                          style={{ width: `${Math.min(100, (state.suspicion / POLICE_THRESHOLD) * 100)}%` }}
                        />
                      </div>
                      {state.policeCalled && !state.status && (
                        <p className="mt-2 text-sm text-rose-300">
                          Police en route! {state.policeTimer} turn{state.policeTimer !== 1 ? 's' : ''} remaining.
                        </p>
                      )}
                      {state.status && state.status.type === 'caught' && (
                        <p className="mt-2 text-sm text-rose-300">Caught! Mission failed.</p>
                      )}
                    </div>

                    <div className="mt-6 grid md:grid-cols-3 gap-4">
                      <div className="bg-slate-800/60 rounded-lg p-3">
                        <div className="text-xs uppercase tracking-wide text-slate-400">Animals Freed</div>
                        <div className="text-xl font-semibold">{state.freedCount}</div>
                      </div>
                      <div className="bg-slate-800/60 rounded-lg p-3">
                        <div className="text-xs uppercase tracking-wide text-slate-400">Families Won</div>
                        <div className="text-xl font-semibold">{state.adoptedCount}</div>
                      </div>
                      <div className="bg-slate-800/60 rounded-lg p-3">
                        <div className="text-xs uppercase tracking-wide text-slate-400">Workers Trapped</div>
                        <div className="text-xl font-semibold">{state.trappedCount}</div>
                      </div>
                    </div>

                    <div className="mt-6 flex flex-wrap gap-2">
                      {Object.entries(DIRECTIONS).map(([key, dir]) => (
                        <button
                          key={key}
                          type="button"
                          className="flex-1 min-w-[120px] bg-slate-800 hover:bg-slate-700 transition-colors border border-slate-600 rounded-lg py-2 text-sm"
                          onClick={() => handleMove(key)}
                          disabled={!!state.status}
                        >
                          Move {dir.label}
                        </button>
                      ))}
                      <button
                        type="button"
                        className="flex-1 min-w-[120px] bg-emerald-700 hover:bg-emerald-600 transition-colors border border-emerald-500 rounded-lg py-2 text-sm"
                        onClick={handleFreeAnimal}
                        disabled={!!state.status}
                      >
                        Free Animal (+1)
                      </button>
                      <button
                        type="button"
                        className="flex-1 min-w-[120px] bg-indigo-700 hover:bg-indigo-600 transition-colors border border-indigo-500 rounded-lg py-2 text-sm"
                        onClick={handleAdoption}
                        disabled={!!state.status}
                      >
                        Win Adoption (+10)
                      </button>
                      <button
                        type="button"
                        className="flex-1 min-w-[120px] bg-amber-700 hover:bg-amber-600 transition-colors border border-amber-500 rounded-lg py-2 text-sm"
                        onClick={handleTrapWorker}
                        disabled={!!state.status}
                      >
                        Trap Worker (+5)
                      </button>
                      <button
                        type="button"
                        className="flex-1 min-w-[120px] bg-slate-800 hover:bg-slate-700 transition-colors border border-slate-600 rounded-lg py-2 text-sm"
                        onClick={handleWait}
                        disabled={!!state.status}
                      >
                        Wait &amp; Watch
                      </button>
                      <button
                        type="button"
                        className="flex-1 min-w-[120px] bg-rose-800 hover:bg-rose-700 transition-colors border border-rose-500 rounded-lg py-2 text-sm"
                        onClick={handleEscape}
                        disabled={!!state.status || !state.policeCalled}
                      >
                        Escape Now
                      </button>
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  <div className="bg-slate-900/70 border border-slate-700 rounded-xl p-4 space-y-3">
                    <h2 className="text-lg font-semibold text-emerald-200">Mission Briefing</h2>
                    <ul className="list-disc list-inside space-y-2 text-sm text-slate-300">
                      <li>Move with the arrow buttons or your keyboard. Avoid bumping into city workers.</li>
                      <li>Freeing any animal grants +1 point. Animals marked with ‚è∞ were scheduled for euthanasia.</li>
                      <li>To earn +10 points, stand next to a family and ensure a volunteer is adjacent to them.</li>
                      <li>Trap a worker by getting adjacent to them and using an empty pen for +5 points.</li>
                      <li>Suspicion rises the closer workers get. Once it maxes out the police are called.</li>
                      <li>If the police are on the way, finish up quickly or hit Escape to slip out safely.</li>
                    </ul>
                  </div>

                  <div className="bg-slate-900/70 border border-slate-700 rounded-xl p-4 space-y-3">
                    <h2 className="text-lg font-semibold text-emerald-200">Shelter Log</h2>
                    <div className="space-y-2 text-sm text-slate-300">
                      {state.log.map((entry, index) => (
                        <p key={index} className="bg-slate-800/60 rounded-md px-2 py-1 border border-slate-700/70">
                          {entry}
                        </p>
                      ))}
                    </div>
                  </div>

                  {state.status && (
                    <div className="bg-slate-900/80 border border-emerald-500/40 rounded-xl p-4 text-center space-y-3">
                      <h2 className="text-xl font-semibold">
                        {state.status.type === 'caught' ? 'Busted!' : 'Mission Complete'}
                      </h2>
                      <p className="text-sm text-slate-300">{state.status.message}</p>
                      <button
                        type="button"
                        className="bg-emerald-700 hover:bg-emerald-600 transition-colors border border-emerald-500 rounded-lg px-4 py-2 text-sm"
                        onClick={resetGame}
                      >
                        Start Again
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<HelterShelterGame />);
  </script>
</body>
</html>
